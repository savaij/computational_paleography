This repository contains the code and data (except images) for the Computational Paleography final project 2024-2025. It is an experiment aimed at creating an image captioning model specialized in medieval illustration and capable of using the TIMEL vocabulary.

## Quick start
If you want to try the Florence-2 finetuned models created within this project, here are their Huggingface links:

- [v1, trained only on keywords](https://huggingface.co/francipaolo/florence-2-pal-comp-v1)

- [v2, trained on caption created by OpenAI gpt-4o-mini from keywords](https://huggingface.co/francipaolo/florence-2-pal-comp-v1)

### Results
_The numbers in parentheses are the equivalent scores of the base model, not finetuned._

| Model | Test Loss | BLEU (1-gram)| BLEU (4-gram)| ROUGE-1 | ROUGE-2 | ROUGE-L |
| ---------------------- | --------- | ----------------- | ----------------- | ----------------- | ----------------- | ----------------- |
| florence-2-pal-comp-v1 | 1.126     | 0.158 (**0.025**) | 0.068 (**0.000**) | 0.213 (**0.021**) | 0.053 (**0.002**) | 0.183 (**0.018**) |
| florence-2-pal-comp-v2 | 1.775     | 0.276 (**0.053**) | 0.060 (**0.003**) | 0.350 (**0.114**) | 0.117 (**0.026**) | 0.252 (**0.091**) |


## Repository Structure

The repository is organized as follows:

- **`code/`**: Contains Jupyter notebooks and Python scripts for various tasks related to the project, such as creating captions, translations, and metrics, as well as fine-tuning models.

    - **`creating_dict.ipynb`**: extracts terms and links from HTML files to ensure consistency of the descriptive terms across the whole dataset.

    - **`create_translation.ipynb`**: focuses on translating medieval-themed French terms into English using model _Mistral-Small-24B-Instruct-2501_.

    - **`translation_metrics.ipynb`**: evaluates the quality of translations using metrics like language detection and semantic similarity. It ensures that translations are accurate and contextually appropriate.

    - **`create_phrases_openai.ipynb`**: generates structured phrases from the English descriptive terms using OpenAI's language models.

    - **`florence_2_finetuning.ipynb`**: fine-tunes the Florence model on the key descriptive terms.

    - **`florence_2_finetuning_openai.ipynb`**: fine-tunes the Florence model on the OpenAI-generated captions.

    - **`caption_metrics.ipynb`**: dedicated to evaluating the performance of image captioning models. It processes captions generated by OpenAI models and applies various metrics to assess their quality and relevance.

- **`data/`**: Contains subfolders for different types of data used in the project.
  - **`elaborated_data/`**: Processed data.
  - **`generated_data/`**: Data generated during experiments.
  - **`original_data/`**: Raw data
  - **`translation_data/`**: Data related to translations.

- **`README.md`**: Provides an overview of the project, its purpose, and details about the dataset.

To use the code, also the actual images are needed, in a folder named `gahom`

<br>

---

<br>

### Details about data

This dataset is extracted from the Image database, the iconographic database maintained by the [ALHoMA](http://ahloma.ehess.fr/) group at EHESS.

The [Online Thesaurus of Medieval Images](http://ahloma.ehess.fr/bases-de-donnees/thesaurus-des-images-medievales-en-ligne-timel/) (TIMEL, [available online](https://datu.ehess.fr/timel/fr/)) is used for the indexing of the images.

The purpose of this dataset is to experiment with different computer vision methods for the automatic indexing of illuminations, ideally following the principles of TIMEL.

It includes:

**`timel_tree.html`**: this file provides a quick view of the term tree (TG/TS) from TIMEL. It is linked to the online version and maps each term to its DOI (`@href`).

**`image_indexing.csv`**: this CSV file (UTF-8, comma-separated) contains metadata and indexing for each image.  
For each image (row), the attributes are:

- [0] `id`: image ID
- [1] `creator`: alhoma
- [2] `collection`: same content as `archival_reference` (with a few exceptions)
- [3] `resource_type`: images_fixes|enluminures
- [4] `conservation_institution`: holding institution
- [5] `contributor`: used for illuminators and patrons from the Vatican database (e.g. `pie_ii:sponsor|gioacchino_di_giovanni_de_gigantibus:illuminator`)
- [6] `archival_reference`: archival reference (to be standardized)
- [7] `date_created`: creation date
- [8] `extent`: used for the manuscript format in the Vatican database
- [9] `folio`: foliation within the manuscript
- [10] `related_dataset_id`: ? (ID corresponding to image name, seems to indicate a relationship between images)
- [11] `incipit`: used for the incipit of some manuscripts from the Vatican database
- [12] `inscription`: transcription of the text in the image
- [13] `source`: biblical or literary reference of the text
- [14] `files`: image path
- [15] `note`: free-form descriptive note
- [16] `timel_nature_place`: DOIs of terms from the TG [nature place](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-yhyygbnb) – `|` separator
- [17] `timel_nature_place_term`: labels of the terms from the TG [nature place](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-yhyygbnb) – `|` separator
- [18] `timel_object_architecture`: DOIs of terms from the TG [object architecture](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-oturfa9i) – `|` separator
- [19] `timel_object_architecture_term`: labels of the terms from the TG [object architecture](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-oturfa9i) – `|` separator
- [20] `timel_character`: DOIs of terms from the TG [character](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-9ygjuwsg) – `|` separator
- [21] `timel_character_term`: labels of the terms from the TG [character](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-9ygjuwsg) – `|` separator
- [22] `timel_subject`: DOIs of terms from the TG [subject](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-rendv4dg) – `|` separator
- [23] `timel_subject_term`: labels of the terms from the TG [subject](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-rendv4dg) – `|` separator
- [24] `timel_thema`: DOIs of terms from the TG [theme](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-y4mebqdz) – `|` separator
- [25] `timel_thema_term`: labels of the terms from the TG [theme](https://datu.ehess.fr/timel/fr/page/?uri=http://data.ehess.fr/thes/timel/medieval/doi:10.34817/tm-y4mebqdz) – `|` separator
- [26] `place_geonames_id`: place of manuscript production, [GeoNames](https://www.geonames.org/) link
- [27] `title`: title of the work

**`image_indexing.json`**: a JSON serialization of `image_indexing.csv` to facilitate extraction. This file notably lists images by TIMEL term (TG>TS).